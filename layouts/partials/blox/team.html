{{/* Hugo Blox: Team */}}
{{/* Questo file va messo in layouts/partial/blox/team.html */}}
{{/* License: https://github.com/HugoBlox/hugo-blox-builder/blob/main/LICENSE.md */}}

{{ $page    := .wcPage }}
{{ $block   := .wcBlock }}
{{ $view    := $block.design.view | default "card" }}
{{ $columns := $block.design.columns | default "2" }}

{{/* Prendo la sezione authors */}}
{{ $authorsSection := site.GetPage "Section" "authors" }}
{{ if not $authorsSection }}
  {{ errorf "Sezione ‘authors’ non trovata: crea content/authors/ con i tuoi profili." }}
{{ end }}

{{/* Raccolgo tutte le pagine markdown sotto content/authors/ */}}
{{ $query := $authorsSection.RegularPages }}

{{/* Filtra solo Kind “page” (esclude le pagine di lista/sezione) */}}
{{ $query = where $query "Kind" "page" }}

{{/* Applica eventuali filtri passati nel front-matter */}}
{{ with $block.content.filters.username }}
  {{ $query = where $query "File.BaseFileName" . }}
{{ end }}
{{ with $block.content.filters.tags }}
  {{ $query = where $query "Params.tags" "intersect" . }}
{{ end }}
{{ with $block.content.filters.featured }}
  {{ $query = where $query "Params.featured" . }}
{{ end }}

{{/* Ordinamento */}}
{{ $sort_by        := $block.content.sort_by | default "Title" }}
{{ $sort_parameter := partial "functions/get_sort_by_parameter" $sort_by }}
{{ $sort_asc       := $block.content.sort_ascending | default false }}
{{ $sort_order     := cond $sort_asc "asc" "desc" }}
{{ $query          = sort $query $sort_parameter $sort_order }}

{{/* Offset & limit */}}
{{ $offset := $block.content.offset | default 0 }}
{{ $count  := $block.content.count  | default 0 }}
{{ if gt $count 0 }}
  {{ if gt $offset 0 }}
    {{ $query = first $count (after $offset $query) }}
  {{ else }}
    {{ $query = first $count $query }}
  {{ end }}
{{ end }}

{{/* Titolo e descrizione del blocco */}}
{{ with $block.content.title }}
  <div class="text-center mb-6">
    <h2 class="text-3xl font-bold">{{ . | emojify | $page.RenderString }}</h2>
    {{ with $block.content.text }}
      <p class="mt-2">{{ . | emojify | $page.RenderString }}</p>
    {{ end }}
  </div>
{{ end }}

<div class="grid grid-cols-1 md:grid-cols-{{ $columns }} gap-8 px-6">
  {{ range $index, $author := $query }}
    {{ with $author.File }}
      {{ $username := .BaseFileName }}
      <div class="team-card p-6 rounded-2xl shadow-lg bg-white dark:bg-gray-800">
        {{ partial "blocks/resume-biography" (dict
            "wcBlock" (dict
              "content" (dict
                "username"    $username
                "text"        ($block.content.item_text | default "")
              )
              "design" $block.design
            )
            "wcPage" $author
        ) }}
      </div>
    {{ end }}
  {{ end }}
</div>